<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" xmlns="http://www.w3.org/1999/html"
      layout:decorate="~{layout/default_layout}">
<th:block layout:fragment="content">
    <!--            본문-->
    <div id="layoutSidenav_content" class="bg-secondary bg-opacity-10">
        <main>
            <div class="container-fluid px-4">
                <div class="content">


                    <h1 class="mt-4 m-3 mb-0">승차권 보기</h1>
                    <ol class="breadcrumb mb-4 m-3 mt-0 ">
                        <li class="breadcrumb-item"><a href="/">홈</a></li>
                        <li class="breadcrumb-item active">승차권 보기</li>
                    </ol>

                    <div class="container-fluid d-flex justify-content-center">


                        <div class="row">

                            <div class="col-12" style="max-width: 1230px"> <!--테이블 col-->
                                <form class="needs">


                                    <!--                  테이블-->
                                    <div class="row">
                                        <!--                    분류-->
                                        <nav aria-label="...">
                                            <ul class="pagination">
                                                <li class="page-item"
                                                    th:classappend="${checkButton == '전체' ? 'active' : ''}">
                                                    <a class="page-link" href="/bus/reservation?specialValue=전체">전체</a>
                                                </li>

                                                <li class="page-item"
                                                    th:classappend="${checkButton == '결제대기' ? 'active' : ''}">
                                                    <a class="page-link"
                                                       href="/bus/reservation?specialValue=결제대기">결제대기</a>
                                                </li>

                                                <li class="page-item"
                                                    th:classappend="${checkButton == '결제완료' ? 'active' : ''}">
                                                    <a class="page-link"
                                                       href="/bus/reservation?specialValue=결제완료">결제완료</a>
                                                </li>

                                                <li class="page-item"
                                                    th:classappend="${checkButton == '만료된 승차권' ? 'active' : ''}">
                                                    <a class="page-link" href="/bus/reservation?specialValue=만료된 승차권">만료된
                                                        승차권</a>
                                                </li>
                                            </ul>
                                        </nav>
                                    </div>
                                    <div class="row">

                                            <table class="table custom-table" id="busTable">
                                                <thead>
                                                <tr>

                                                    <th:block th:if="${checkButton == '전체'}">
                                                        <th scope="col">출발 일자</th>
                                                        <th scope="col">출발 시간</th>
                                                        <th scope="col">출발 / 도착지</th>
                                                        <th scope="col">비용</th>
                                                        <th scope="col">상세보기</th>
                                                    </th:block>

                                                    <th:block th:if="${checkButton == '만료된 승차권'}">
                                                        <th scope="col">출발 일자</th>
                                                        <th scope="col">출발 시간</th>
                                                        <th scope="col">출발 / 도착지</th>
                                                        <th scope="col">비용</th>
                                                        <th scope="col">상세보기</th>
                                                        <th scope="col">영수증</th>
                                                    </th:block>

                                                    <th:block th:if="${checkButton == '결제대기'}">
                                                        <th scope="col">선택</th>
                                                        <th scope="col">출발 일자</th>
                                                        <th scope="col">출발 시간</th>
                                                        <th scope="col">출발 / 도착지</th>
                                                        <th scope="col">비용</th>
                                                        <th scope="col">상세보기</th>
                                                    </th:block>

                                                    <th:block th:if="${checkButton == '결제완료'}">
                                                        <th scope="col">선택</th>
                                                        <th scope="col">결제번호</th>
                                                        <th scope="col">출발 일자</th>
                                                        <th scope="col">출발 시간</th>
                                                        <th scope="col">출발 / 도착지</th>
                                                        <th scope="col">상세보기</th>
                                                        <th scope="col">영수증</th>
                                                    </th:block>

                                                </tr>
                                                </thead>
                                                <tbody>

                                                <th:block th:if="${checkButton == '전체'}">

                                                    <!--                                                    반복td-->
                                                    <th:block th:each="reservation, iteration : ${ReservationList}">
                                                        <tr class="cstr">
<!--                                                            reservationStatus이라는 컬럼 결제대기: unpaid, 결제완료: paid, 만료: expired-->
<!--                                                            th:classappend="" 를 사용해 전체 데이터 내려왔을 때 만료된 친구는 "cstrexpr" (검은색)으로 준다. 결제 대기인 친구는 "cstrwait", 결제 완료 친구는 "cstrdone"-->
                                                            <td th:text="${reservation.departureDate}"></td>
                                                            <td th:text="${reservation.departureTime}"></td>
                                                            <td th:text="${reservation.departure} + ' - ' + ${reservation.destination}"></td>
                                                            <td th:text="${reservation.payment} + '원'"></td>
                                                            <td>
                                                                <button type="button" class="btn btn-primary"
                                                                        onclick="clk(this)" th:id="${reservation.id}">
                                                                    승차권 보기
                                                                </button>
                                                            </td>
                                                        </tr>
                                                        <tr class="spacer">
                                                            <td colspan="100"></td>
                                                        </tr>
                                                    </th:block>
                                                    <!--                                                    반복td-->



                                                </th:block>

                                                <th:block th:if="${checkButton == '만료된 승차권'}">

                                                    <!--                                                    반복td-->
                                                    <th:block th:each="reservation, iteration : ${ReservationList}">
                                                        <tr class="cstr">
                                                            <!--                                                            th:classappend="" 를 사용해 전체 데이터 내려왔을 때 만료된 친구는 "cstrnone"으로 준다-->
                                                            <td th:text="${reservation.departureDate}"></td>
                                                            <td th:text="${reservation.departureTime}"></td>
                                                            <td th:text="${reservation.departure} + ' - ' + ${reservation.destination}"></td>
                                                            <td th:text="${reservation.payment} + '원'"></td>
                                                            <td>
                                                                <button type="button" class="btn btn-primary"
                                                                        onclick="clk(this)" th:id="${reservation.id}">
                                                                    승차권 보기
                                                                </button>
                                                            </td>
                                                            <td>
                                                                <button type="button" class="btn btn-secondary"
                                                                        onclick="clkBil(this)" th:id="${reservation.impUid}">
                                                                    <!--                      타임리프 주문번호-->
                                                                    영수증
                                                                </button>
                                                            </td>
                                                        </tr>
                                                        <tr class="spacer">
                                                            <td colspan="100"></td>
                                                        </tr>
                                                    </th:block>
                                                    <!--                                                    반복td-->

                                                </th:block>

                                                <th:block th:if="${checkButton == '결제대기'}">

                                                    <!--                                                    반복td-->
                                                    <th:block th:each="reservation, iteration : ${ReservationList}">
                                                        <tr class="cstr">
                                                            <td>
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" style="width:25px;height:25px;position:relative;left:23px"
                                                                           name="data" th:value="${reservation.id}">
                                                                </div>
                                                            </td>
                                                            <td th:text="${reservation.departureDate}"></td>
                                                            <td th:text="${reservation.departureTime}"></td>
                                                            <td th:text="${reservation.departure} + ' - ' + ${reservation.destination}"></td>
                                                            <td th:text="${reservation.payment} + '원'"></td>
                                                            <td>
                                                                <button type="button" class="btn btn-primary"
                                                                        onclick="clk(this)" th:id="${reservation.id}">
                                                                    승차권 보기
                                                                </button>
                                                            </td>
                                                        </tr>
                                                        <tr class="spacer">
                                                            <td colspan="100"></td>
                                                        </tr>
                                                    </th:block>
                                                    <!--                                                    반복td-->

                                                </th:block>

                                                <th:block th:if="${checkButton == '결제완료'}">

                                                    <!--                                                    반복td-->
                                                    <th:block th:each="reservation, iteration : ${ReservationList}">
                                                        <tr class="cstr">
                                                            <td>
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox" style="width:25px;height:25px;position:relative;left:23px"
                                                                           name="data" th:value="${reservation.id}">
                                                                </div>
                                                            </td>
                                                            <td th:text="${reservation.impUid}"></td>
                                                            <td th:text="${reservation.departureDate}"></td>
                                                            <td th:text="${reservation.departureTime}"></td>
                                                            <td th:text="${reservation.departure} + ' - ' + ${reservation.destination}"></td>
                                                            <td>
                                                                <button type="button" class="btn btn-primary"
                                                                        onclick="clk(this)" th:id="${reservation.id}">
                                                                    승차권 보기
                                                                </button>
                                                            </td>
                                                            <td>
                                                                <button type="button" class="btn btn-secondary"
                                                                        onclick="clkBil(this)" th:id="${reservation.impUid}">
                                                                    <!--                      타임리프 주문번호-->
                                                                    영수증
                                                                </button>
                                                            </td>
                                                        </tr>
                                                        <tr class="spacer">
                                                            <td colspan="100"></td>
                                                        </tr>
                                                    </th:block>
                                                    <!--                                                    반복td-->

                                                </th:block>


                                                </tbody>
                                            </table>
                                    </div>

                                </form>

                            </div>

                            <div class="row" style="height: 30px"></div>
                            <th:block th:if="${checkButton == '전체' or checkButton == '만료된 승차권'}">


                            </th:block>

                            <th:block th:if="${checkButton == '결제대기'}">

                                <div class="row">
                                    <button type="submit" class="btn btn-primary mb-3" style="width:100px" id="pay">결제
                                    </button>
                                </div>

                            </th:block>

                            <th:block th:if="${checkButton == '결제완료'}">

                                <div class="row">
                                    <button type="submit" class="btn btn-primary mb-3" style="width:100px" id="cancel">취소
                                    </button>
                                </div>

                            </th:block>

                        </div>

                    </div>

                </div>

                <!--          모달-->
                <div class="modal" id="myModal">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
<!--                            <div class="modal-header">-->
<!--                                <p class="modal-title">preview</p>-->
<!--                                <button type="button" class="btn-close" data-bs-dismiss="modal"-->
<!--                                        aria-label="Close"></button>-->
<!--                            </div>-->
                            <div class="modal-body">

                                <!--                    티켓-->
                                <div class="container-fluid rounded shadow-lg" style="width:295px">

                                    <div class="row">
                                        <div class="col-12 bg-warning rounded-top" style="height: 210px">
                                            <div class="row" style="height: 30px"></div>
                                            <div class="row" style="height: 30px">
                                                <div class="col-12 d-flex justify-content-center">
                                                    <p class="fw-bold" style="color: black">Bus Pass</p>
                                                </div>
                                            </div>
                                            <div class="row" style="height: 40px"></div>
                                            <div class="row">
                                                <div class="col-6">
                                                    <h1 class="d-flex justify-content-center"
                                                        style="color: #ffc107;text-shadow: -1px 0 #000, 0 1px #000, 1px 0 #000, 0 -1px #000;"
                                                        id="modalDeparts"></h1>
                                                    <h2 style="position: relative;left: 30px;"
                                                        id="modalArrivals"></h2>
                                                </div>
                                                <div class="col-6 gx-4 gy-2">
                                                    <h2 class="d-flex justify-content-center"><i
                                                            class="fa-solid fa-bus"></i></h2>
                                                    <div style="height: 15px"></div>
                                                    <p class="d-flex justify-content-center" style="color: black"
                                                       id="modalBusType"></p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!--                    1열-->
                                    <div class="row">
                                        <div class="col-4 p-3">
                                            <div class="row">
                                                <div class="col-12"><p>BusID</p></div>
                                                <div class="col-12 fw-bold" id="modalBusId"></div>
                                            </div>
                                        </div>
                                        <div class="col-4 p-3"></div>
                                        <div class="col-4 p-3">
                                            <div class="row">
                                                <div class="col-12"><p>Home</p></div>
                                                <div class="col-12 fw-bold" id="modalDeparts2"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <!--                    2열-->
                                    <div class="row">
                                        <div class="col-4 p-3">
                                            <div class="row">
                                                <div class="col-12"><p>Date</p></div>
                                                <div class="col-12 fw-bold" id="modalBookedDate"></div>
                                            </div>
                                        </div>
                                        <div class="col-4 p-3">
                                            <div class="row">
                                                <div class="col-12"><p>Departs</p></div>
                                                <div class="col-12 fw-bold" id="modalDepartTime"></div>
                                            </div>
                                        </div>
                                        <div class="col-4 p-3">
                                            <div class="row">
                                                <div class="col-12"><p>Arrivers</p></div>
                                                <div class="col-12 fw-bold" id="modalArrivalTime"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <!--                    3열-->
                                    <div class="row">
                                        <div class="col-12">
                                            <hr>
                                        </div>
                                    </div>
                                    <!--                    4열-->
                                    <div class="row">
                                        <div class="col-5 p-3">
                                            <div class="row">
                                                <div class="col-12"><p>PassType</p></div>
                                                <div class="col-12 fw-bold" id="modalPassType"></div>
                                            </div>
                                        </div>
                                        <div class="col-3 p-3">
                                            <div class="row">
                                                <div class="col-12"><p>Seat</p></div>
                                                <div class="col-12 fw-bold" id="modalSeatNum"></div>
                                            </div>
                                        </div>
                                        <div class="col-4 p-3">
                                            <div class="row">
                                                <div class="col-12"><p>Cost</p></div>
                                                <div class="col-12 fw-bold" id="modalCost"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <!--                    5열-->
                                    <div class="row">
                                        <div class="col-12 d-flex justify-content-center"><img
                                                src="../assets/img/testqr.png" style="width: 65px;height: 65px;">
                                        </div>
                                    </div>
                                    <!--                    6열-->
                                    <div class="row">
                                        <div class="col-12">
                                            <hr>
                                        </div>
                                    </div>
                                    <!--                    티켓-->
                                </div>

                            </div>
<!--                            <div class="modal-footer">-->
<!--                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">돌아가기-->
<!--                                </button>-->
<!--                            </div>-->
                        </div>
                    </div>
                </div>


            </div>
    </main>
    </div>

    </div>
    <!--            본문-->
    <script th:inline="javascript">


        // 승차권 모달창
        function clk(obj) {

            console.log(obj.id);

            var url = "/read/detail/" + obj.id;
            console.log(url);
            $.ajax({
                url: url,
                type: "GET",
                dataType: "json",
                success: function (data) {

                    console.log("API 로딩 성공")
                    reservationDataList = data;

                    $("#modalArrivals").empty();
                    var tempi = $("<i>").attr("class", "fas fa-arrow-right");
                    $("#modalArrivals").append(tempi);
                    $("#modalArrivals").append(reservationDataList.destination);
                    $("#modalDeparts").empty();
                    $("#modalDeparts").append(reservationDataList.departure);
                    $("#modalBusType").empty();
                    $("#modalBusType").append(reservationDataList.busType);
                    $("#modalBusId").empty();
                    $("#modalBusId").append(reservationDataList.busNum);
                    $("#modalDeparts2").empty();
                    $("#modalDeparts2").append(reservationDataList.departure);
                    $("#modalBookedDate").empty();
                    $("#modalBookedDate").append(reservationDataList.departureDate);
                    $("#modalDepartTime").empty();
                    $("#modalDepartTime").append(reservationDataList.departureTime);
                    $("#modalArrivalTime").empty();
                    $("#modalArrivalTime").append(reservationDataList.arrivalTime);
                    $("#modalPassType").empty();
                    $("#modalPassType").append(reservationDataList.passengerType);
                    $("#modalSeatNum").empty();
                    $("#modalSeatNum").append(reservationDataList.seatNum);
                    $("#modalCost").empty();
                    $("#modalCost").append(reservationDataList.payment);

                    const myModal = new bootstrap.Modal(document.getElementById('myModal'));
                    myModal.show();

                },
                error: function (xhr, status, error) {
                    console.error(error);
                }
            });

        }


        /*[# th:if="${checkButton} == '만료된 승차권' or ${checkButton} == '결제완료'"]*/

        // 영수증 모달창
        function clkBil(obj) {

            console.log(obj.id);

            var url = "/bus/receipt/" + obj.id;
            console.log(url);
            $.ajax({
                url: url,
                type: "GET",
                dataType: "json",
                success: function (data) {

                    console.log("API 로딩 성공")
                    paymentDataList = data;

                    console.log(paymentDataList);

                    // 밑의 예시처럼 지우고 넣어주기
                    // $("#modalDeparts").empty();
                    // $("#modalDeparts").append(reservationDataList.departure);
                    // $("#modalBusType").empty();
                    // $("#modalBusType").append(reservationDataList.busType);

                    // const myModalBil = new bootstrap.Modal(document.getElementById('내모달'));
                    // myModalBil.show();

                },
                error: function (xhr, status, error) {
                    console.error(error);
                }
            });

        }
        /*[/]*/


        /*[# th:if="${checkButton} == '결제대기'"]*/
        // 결제 폼
        (function () {
            'use strict';

            var button = document.getElementById('pay'); // 특정 버튼의 id를 지정해주세요.
            var form = document.querySelector('.needs');

            button.addEventListener('click', function (event) {
                event.preventDefault();

                var selectedValues = [];
                var checkboxes = form.querySelectorAll('input[name="data"]:checked');
                checkboxes.forEach(function (checkbox) {
                    selectedValues.push(checkbox.value);
                });

                console.log(selectedValues);

                if (selectedValues.length === 0) {
                    alert("결제할 항목을 1개 이상 선택해주세요!");
                } else {
                    // 폼 전송 로직 추가
                    form.method = 'POST';
                    form.action = "/bus/payment";
                    form.submit();
                }
            });
        })();
        /*[/]*/


        /*[# th:if="${checkButton} == '결제완료'"]*/
        // 취소 폼
        (function () {
            'use strict';

            var button = document.getElementById('cancel'); // 특정 버튼의 id를 지정해주세요.
            var form = document.querySelector('.needs');

            button.addEventListener('click', function (event) {
                event.preventDefault();

                var selectedValues = [];
                var checkboxes = form.querySelectorAll('input[name="data"]:checked');
                checkboxes.forEach(function (checkbox) {
                    selectedValues.push(checkbox.value);
                });

                console.log(selectedValues);

                if (selectedValues.length === 0) {
                    alert("취소할 항목을 1개 이상 선택해주세요!");
                } else {
                    // 폼 전송 로직 추가
                    form.method = 'POST';
                    form.action = "/bus/cancel";
                    form.submit();
                }
            });
        })();
        /*[/]*/


    </script>

</th:block>

</html>
<style>
</style>


